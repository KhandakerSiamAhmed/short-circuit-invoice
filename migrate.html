<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Migrate Data - Short Circuit</title>
    <link rel="icon" href="Short Circuit .PNG">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="db.js"></script>
    <script src="pricelist.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        pre {
            background: #f0f0f0;
            padding: 10px;
        }
    </style>
</head>

<body>
    <h1>Migrate Data to Supabase</h1>
    <div style="margin-bottom: 20px;">
        <button onclick="startMigration()"
            style="padding: 10px 20px; font-size: 16px; background: #fee2e2; color: #991b1b;">Clear All & Fresh Migrate
            (Batch)</button>
    </div>
    <div id="log"></div>

    <script>
        async function startMigration() {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML = '<p>Starting batch migration...</p>';

            if (typeof PRICE_LIST === 'undefined') {
                logDiv.innerHTML += '<p style="color:red">Error: PRICE_LIST not found in pricelist.js</p>';
                return;
            }


            logDiv.innerHTML += '<p>Clearing existing products...</p>';
            const { error: delError } = await _supabase.from('products').delete().neq('id', 0);
            if (delError) {
                logDiv.innerHTML += `<p style="color:red">Clear failed: ${delError.message}</p>`;
                return;
            }
            logDiv.innerHTML += '<p style="color:green">Database cleared.</p>';


            const payload = PRICE_LIST.map(item => ({
                name: item.name,
                price: item.selling_price || 0,
                buying_price: item.buying_price || 0,
                category: item.category || 'Uncategorized'
            }));

            logDiv.innerHTML += `<p>Inserting ${payload.length} items in batch...</p>`;


            const { data, error } = await _supabase.from('products').insert(payload).select();

            if (error) {
                logDiv.innerHTML += `<p style="color:red">Batch insert failed: ${error.message}</p>`;
                return;
            }

            logDiv.innerHTML += `<p style="color:green; font-weight:bold;">✅ Successfully inserted ${data.length} items!</p>`;


            data.forEach(item => {
                logDiv.innerHTML += `<p style="color:green; margin:2px 0; font-size:13px;">  ✓ ${item.name} (Buy: ${item.buying_price} Tk, Sell: ${item.price} Tk)</p>`;
            });

            logDiv.innerHTML += `<h3>Migration Completed! ${data.length} items processed.</h3>`;
        }
    </script>
</body>

</html>